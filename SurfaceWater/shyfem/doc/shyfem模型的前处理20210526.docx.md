# SHYFEM模型的前处理：计算网格

## 1、概述

SHYFEM模型使用非结构网格，分为2种：

-   filename.grd（ASCII）：[此grd格式不同于ADCIRC模型的grd网格文件格式。]{.mark}

-   filename.bas（二进制）

用户必须创建第1种，程序自动计算得到第2种。bas文件是程序真正使用的网格。

grd文件内容由3部分组成，描述不同的几何对象，分别是：

节点、单元和线（包含等值线信息和节点）。

grd文件格式：

![](./media/image1.emf)

![](./media/image2.emf)

创建grd文件的步骤：

（1）获取海岸线和水下地形的原始数据，转换为grd格式；

（2）如果需要，光滑和稀疏海岸线数据；

（3）使用网格生成程序创建计算网格；

（4）调整计算网格；

（5）将地形插值到创建的网格上；

（6）创建二进制格式的bas文件。

## 2、海岸线和水下地形

可使用脚本程序：coast.pl，将简单的海岸线文件(x,y)转成grd文件，运行：

coast.pl mpcoast.dat \> coast.grd

完成后，可使用grid程序检查海岸线：

grid coast.grd

如果地形文件格式是(x,y,z)，可转换：

bathy.pl mpbathy.dat \> depth.grd

也可使用grid检查depth.grd文件。

通常，UTM坐标数值很大，[需要移动坐标到新的坐标系，]{.mark}与区域的中央点重合，可使用grd_transl.pl平移。其他的平移脚本程序还有：

dxf2grd.pl：将dxf(AutoCAD )的海岸线转为grd格式；

kml2grd.pl：将KML格式的海岸线转为grd格式；

xyz2grd.pl：将节点转为grd格式，每行包含3个数值(x,y,z)或2个值(x,y)

注意：SHYFEM的水深数值必须是正的。如果有负数的水深，必须转过来，使用命令：

grd_modify.pl -depth_invert grd-file

## 3、边界线：光滑和稀疏

通常，海岸线需要一些后处理。海岸线的分辨率可能过高，或者海岛可能显示为不封闭的线。

注意：必须有一个封闭的边界线定义整个计算域。如果有不封闭的海岸线，必须使用grid程序来封闭，或设为开边界。

一旦边界线定义好了，该区域内部的线段将被封闭，表示小岛。

最终，边界线（海岸线和小岛）需要调整。如果海岸线分辨率过高，附近的网格分辨率也会很高。[可使用reduce程序光滑和稀疏边界线]{.mark}：

reduce -s sigma -r reduct coast.grd

这里，sigma定义光滑算子的长度；reduct定义低于该值将被删除。2个数值需要与coast.grd中的坐标单位一样。光滑文件在smooth.grd，稀疏后的文件是reduct.grd

如果网格文件的水深值设置为-1，这些点将不会删除或光滑。

## 4、操作节点、边和单元：grid程序

grid程序不仅可视化grd文件，还可以在GUI上操作网格的不同对象（节点、单元和边）。命令如下：

![](./media/image3.emf)

GUI命令：

![](./media/image4.emf)

GUI菜单有：

![](./media/image5.emf)

Change

![](./media/image6.emf)

![](./media/image7.emf)

## 5、创建网格

推荐使用gmsh程序生成网格，转换为grd格式：

![](./media/image8.emf)

也可使用SHYFEM中的mesh程序生成网格，mesh --h

需要为mesh计算提供外边界的海岸线，mesh程序在其中插入三角形。必须满足：必须有一个封闭的外部线段。不同同时划分2个独立区域的网格。

![](./media/image9.emf)

如果划分均匀网格：mesh --I2000
coast-new.grd，划分的网格在final.grd。数字2000表示计算域上有大约2000个点。

如果要划分不均匀网格，则必须构建一个背景网格，指示哪个区域用多大分辨率的网格。背景网格的水深等于1，分辨率不变；大于1，分辨率增加；小于1，分辨率降低。背景网格的所有节点需要水深（分辨率）值。在各背景网格单元内部，分辨率在3个节点之间插值。

设置背景网格的单元类型为99

[构建背景网格]{.mark}：exgrd --LS
coast-new.grd，new.grd仅包含背景网格，重命名：mv new.grd
bck1.grd。下面是创建背景网格的步骤：

（1）使用coast-new.grd手动创建背景网格；

（2）删除海岸线(exgrd --LS coast-new.grd)。这样，文件中仅剩下背景单元。

（3）设置节点上的水深（分辨率）；

（4）单元类型设置为99

（5）重命名为bck1.grd：mv new.grd bck1.grd

现在，可以指定网格划分算法mesh。

### 5.1 计算域网格划分 {#计算域网格划分 .标题3}

mesh的主要参数：

-I2000 use aprox. 2000 internal nodes for the domain

-g99 element type of background grid is 99

例如：mesh --I2000 --g99 coast-new bck1

生成的网格在final.grd

注意：可以有多个定义海岸线的文件，因此需要将海岸线和小岛岸线放在单独的文件中。也可以为[不同区域]{.mark}，在不同文件中指定[不同的背景网格]{.mark}。因此有：

mesh -I2000 -g99 coast island1 island2 bck1 bck2 bck3

完成网格划分后需要查看结果(final.grd)。需要要增加整体的分辨率，可以增加内部网格节点数（此处的2000）。如果要更高分辨率的背景网格，打开背景网格文件，增大某些区域的因子数（水深）。如果对生成的网格质量满意，可以保存为其他名字：

mesh -I2000 -g99 coast-new bck1

mv final.grd mesh1.grd

### 5.2调整单元的规则度

有些网格单元太不规则，需要调整。

regularize mesh1.grd mesh2.grd

mesh1.grd是不规则网格。

## 6、将地形插值到网格上

shybas -bfile bathy.grd mesh2.grd

bathy.grd是grd格式的地形文件，mesh2.grd是待插值地形的网格文件。

可使用不同的插值方法，运行：shybas -h

## 7、创建bas文件

前处理程序shypre用来生成bas二进制文件，运行：

shypre final_mesh.grd

shypre优化节点和单元的内部编码。组装系统矩阵时，如果单元是以最小的节点数编码，则在计算机内存中节点指针访问更规则，降低了页切换。

但节点重编码是必须的。系统矩阵以带状矩阵形式求解。带宽减半，计算效率提高4倍。带宽等于一个单元中最大的节点数。但降低带宽的方式是经验性的，目前有2个主要算法来降低带宽：Cuthill McGee算法和Rosen算法。第1种算法是从一个节点开始，以贪婪方式编码所有的相邻节点编号，仅在一步内优化编码。然后依次编码相邻节点。

建议自动优化编码，也可以按照指示，手动优化网格编码。

### 7.1 内部和外部节点编码

节点和单元编码的优化对用户是透明的。程序保持从原始编码（外部编码）向优化编码（内部编码）的指针。甚至程序内部使用其他的编码系统，用户也必须处理外部编码。

另外，内部编码是连续生成的。因此，如果系统中存在4000个节点，内部节点将从1计算到4000。另方面，外部节点编号可以是用户指定的，但必须是唯一的。这允许用户在不对计算域重新编码的情况下，添加和删除节点。

再次使用外部编码的节点，必须在输入参数文件中定义。这样，改变计算域的结构，完全不用修改输入参数文件中的单元和节点编号，除非修改了参数文件中指定的节点和单元。

# MPI并行化SHYFEM模型

## 网格分区

shyparts
